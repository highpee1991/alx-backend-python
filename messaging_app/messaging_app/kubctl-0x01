#!/bin/bash
# kubctl-0x01
# Script to scale Django app deployment and test scaling

set -e

DEPLOYMENT_NAME=django-app  # <-- change this if your deployment has a different name
NAMESPACE=default           # <-- change this if you're using another namespace

echo "ðŸ“Œ Scaling deployment $DEPLOYMENT_NAME to 3 replicas..."
kubectl scale deployment $DEPLOYMENT_NAME --replicas=3 -n $NAMESPACE

echo "âœ…  Verifying running pods..."
kubectl get pods -n $NAMESPACE -o wide

echo "âœ…  Checking resource usage..."
kubectl top pods -n $NAMESPACE || echo "âš  Metrics server not installed. Run: kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml"

echo "âœ…  Performing load test with wrk..."
# Replace NODE_PORT and NODE_IP with your service values
NODE_PORT=$(kubectl get svc $DEPLOYMENT_NAME -n $NAMESPACE -o jsonpath='{.spec.ports[0].nodePort}')
NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[0].address}')

wrk -t2 -c50 -d30s http://$NODE_IP:$NODE_PORT/
